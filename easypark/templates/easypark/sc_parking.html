<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายละเอียดสถานที่จอดรถ</title>
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #333;
            color: white;
            padding: 10px 20px;
        }

        .header .logo {
            display: flex;
            align-items: center;
        }

        .header .logo img {
            height: 40px;
            margin-right: 10px;
        }

        .header .logo h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header .nav-menu a {
            color: white;
            text-decoration: none;
            margin-right: 15px;
            font-size: 1rem;
        }

        .header .nav-menu a:hover {
            text-decoration: underline;
        }

        .header .user-icon img {
            height: 40px;
            cursor: pointer;
            border-radius: 50%;
        }

        .container {
            padding: 20px;
        }

        .map-container {
            margin-bottom: 20px;
        }

        .map-container img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
    <!-- Header Section -->
    <div class="header">
        <div class="logo">
            <img src="{% static 'easypark/image/logo.png' %}" alt="Easy Parking Logo">
            <h1>Easy Parking</h1>
        </div>
        <div class="nav-menu">
            <a href="{% url 'homepage' %}">หน้าหลัก</a>
            <a href="#">แผนที่</a>
        </div>
        <div class="user-icon">
            <a href="{% url 'profile' %}">
                <img src="{% static 'easypark/image/user_1.png' %}" alt="User Icon">
            </a>
        </div>
    </div>
    </div>
    <style>
        .container {
            display: flex;
            justify-content: space-around;
            margin: 20px;
            padding: 10px;
        }

        .map-container {
            flex: 1;
            margin-right: 20px;
        }

        .map-container img {
            width: 100%;
            max-width: 550px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .parking-spot {
            width: 50px;
            height: 50px;
            display: inline-block;
            margin: 5px;
            background-color: grey;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            border-radius: 15px;
        }

        .back-button {
            text-align: right;
            margin-top: 20px;
        }

        .back-button a {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
        }

        .back-button a:hover {
            background-color: #45a049;
        }

        #details-container {
            display: none;
            /* เริ่มต้นไม่แสดง */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 400px;
            max-width: 80%;
        }

        .modal-overlay {
            display: none;
            /* เริ่มต้นไม่แสดง */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            background-color: red;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
        }

        .close-btn:hover {
            background-color: darkred;
        }

        .reserve-btn {
            background-color: #4CAF50;
            /* สีเขียว */
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .reserve-btn:hover {
            background-color: #45a049;
            transform: scale(1.05);

        }

        .reserve-btn:active {
            transform: scale(0.95);

        }

        .reserve-btn:disabled {
            background-color: grey;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>


    <div class="container">
        <svg id="parking-map" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 300" width="100%" height="100%">
            <image href="{% static 'easypark/image/2.png' %}" x="0" y="0" width="500" height="300" />
            <g id="spot-1" onclick="showSpotDetails(1)"></g>
            <g id="spot-2" onclick="showSpotDetails(2)"></g>
            <g id="spot-3" onclick="showSpotDetails(3)"></g>
            <g id="spot-4" onclick="showSpotDetails(4)"></g>
            <g id="spot-5" onclick="showSpotDetails(5)"></g>
            <g id="spot-6" onclick="showSpotDetails(6)"></g>
            <g id="spot-7" onclick="showSpotDetails(7)"></g>
            <g id="spot-8" onclick="showSpotDetails(8)"></g>
            <g id="spot-9" onclick="showSpotDetails(9)"></g>
        </svg>


    </div>


    <!-- Modal -->
    <div id="modal-overlay"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;">
        <div id="details-container"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); z-index: 1000;">
        </div>
    </div>

    <script>
        const locationId = 1;

        // กำหนดตำแหน่งคงที่สำหรับแต่ละ spot_number
        const positions = {
            1: { x: 325, y: 193 },
            2: { x: 290, y: 193 },
            3: { x: 255, y: 193 },
            4: { x: 221, y: 193 },
            5: { x: 187, y: 193 },
            6: { x: 159, y: 193 },
            7: { x: 500, y: 300 },
            8: { x: 600, y: 300 },
            9: { x: 700, y: 300 },
        };

        function fetchParkingStatus() {
            console.log("Fetching parking status...");
            $.ajax({
                url: "{% url 'get_parking_status' %}",
                method: "GET",
                data: { location_id: locationId },
                success: function (data) {
                    console.log("Parking status fetched:", data);

                    // ลูปข้อมูลจาก API และเพิ่ม SVG ให้ครบทุกช่อง
                    data.forEach(function (spot) {
                        const spotElement = document.querySelector(`#spot-${spot.spot_number}`);
                        if (!spotElement) {
                            console.warn(`Spot element with id spot-${spot.spot_number} not found.`);
                            return;
                        }

                        // ล้างเนื้อหาเดิมก่อนสร้างใหม่
                        spotElement.innerHTML = '';

                        // สร้าง SVG Path
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");

                        if (spot.is_available) {
                            path.setAttribute("fill", "#22db14"); // สีเขียว (ว่าง)
                            path.setAttribute("d", "M64 80c-8.8 0-16 7.2-16 16l0 320c0 8.8 7.2 16 16 16l320 0c8.8 0 16-7.2 16-16l0-320c0-8.8-7.2-16-16-16L64 80zM0 96C0 60.7 28.7 32 64 32l320 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM337 209L209 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L303 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z");
                        } else {
                            path.setAttribute("fill", "#ff0000"); // สีแดง (ไม่ว่าง)
                            path.setAttribute("d", "M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c-9.4 9.4-9.4 24.6 0 33.9l47 47-47 47c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l47-47 47 47c-9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-47-47 47-47c-9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-47 47-47-47c-9.4-9.4-24.6-9.4-33.9 0z");

                        }

                        // ตั้งค่าตำแหน่งตาม spot_number
                        const position = positions[spot.spot_number] || { x: 0, y: 0 }; // ถ้าไม่มีตำแหน่ง ให้ค่าเริ่มต้นเป็น (0, 0)
                        path.setAttribute("transform", `translate(${position.x}, ${position.y}) scale(0.05)`);

                        // เพิ่ม path เข้าไปใน group
                        spotElement.appendChild(path);
                    });
                },
                error: function () {
                    console.error("Error fetching parking status");
                }
            });
        }

        // เรียก API ทุกๆ 2 วินาที
        setInterval(fetchParkingStatus, 2000);



        setInterval(fetchParkingStatus, 2000);


        function showSpotDetails(spotNumber) {
            $.ajax({
                url: "{% url 'get_spot_details' %}",
                method: "GET",
                data: { location_id: locationId, spot: spotNumber },
                success: function (data) {
                    const detailsContainer = document.getElementById("details-container");
                    if (!data || typeof data !== "object" || data.error) {
                        detailsContainer.innerHTML = `<p>${data.error || "ไม่สามารถโหลดข้อมูลได้"}</p>`;
                    } else {
                        detailsContainer.innerHTML = `
                    <h3>ช่องจอดหมายเลข ${spotNumber}</h3>
                    <p>สถานะ: ${data.is_available ? "ว่าง" : "ไม่ว่าง"}</p>
                    <p>จองโดย: ${data.reserved_by || "ไม่มีข้อมูล"}</p>
                    <p>ทะเบียนรถ: ${data.license_plate || "ไม่มีข้อมูล"}</p>
                    ${data.is_available ?
                                `<button class="reserve-btn" onclick="goToReservePage(${spotNumber})">จองที่นี่</button>` :
                                `<p style="color: red;">ไม่สามารถจองได้</p>`}
                    <button class="close-btn" onclick="closeModal()">ปิด</button>
                `;
                    }
                    showModal();
                },
                error: function () {
                    console.error("Error fetching spot details");
                    const detailsContainer = document.getElementById("details-container");
                    detailsContainer.innerHTML = `<p>ไม่สามารถโหลดข้อมูลได้ในขณะนี้ โปรดลองอีกครั้ง</p>`;
                    detailsContainer.innerHTML += `<button class="close-btn" onclick="closeModal()">ปิด</button>`;
                    showModal();
                }
            });
        }


        function goToReservePage(spotNumber) {
            if (isNaN(spotNumber)) {
                alert("ข้อมูลไม่ถูกต้อง");
                return;
            }

            const locationId = 1;
            if (!locationId) {
                alert("Location ID ไม่ถูกต้อง");
                return;
            }
            window.location.href = `/reserve_page/${spotNumber}/?location_id=${locationId}`;
        }

        function showModal() {
            const overlay = document.getElementById("modal-overlay");
            document.getElementById("details-container").style.display = "block";
            overlay.style.display = "block";

            overlay.addEventListener("click", function (event) {
                if (event.target === overlay) {
                    closeModal();
                }
            }, { once: true });
        }

        function closeModal() {
            document.getElementById("details-container").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";
        }



        // อัปเดตสถานะที่จอดรถทุกๆ 2 วินาที
        setInterval(fetchParkingStatus, 2000);
    </script>


</body>

</html>